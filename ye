<?php
session_start();

// Очистка всех куки
foreach($_COOKIE as $key => $value) {
    setcookie($key, '', time() - 3600, '/');
}

// Функция для генерации случайной строки
function generateCode($length=6) {
    $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    $code = "";
    $clen = strlen($chars) - 1;
    while (strlen($code) < $length) {
        $code .= $chars[mt_rand(0,$clen)];
    }
    return $code;
}

$hello = "";
$link = mysqli_connect("localhost", "root", "", "1test_system");

if (isset($_POST['login'])) {
    $login  = $_POST['login'];
    $passw  = $_POST['password'];

    // Вытаскиваем из БД запись, у которой login равен введённому
    $query = mysqli_query($link,"SELECT login FROM list WHERE login='".mysqli_real_escape_string($link,$login)."' LIMIT 1");
    $data  = mysqli_fetch_assoc($query);

    // Проверяем логин и пароль (логин == пароль)
    if ($data !== null && $data['login'] === $passw) {
        $hash  = generateCode(10);
        $insip = date('Y/m/d H:i:s');

        // Ставим куки
        setcookie("employee_number", $passw, time()+60*60*24*30, "/");

        header("Location: opros.php"); 
        exit(); 
    } else {	
        $hello = "Вы ввели неправильный логин/пароль"; 
    }

    $_POST = array();
}
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Опрос</title>
    <link href="style_xtvs.css" rel="stylesheet">
    <style>
        textarea[name="password"] {
          resize: none;
          -webkit-text-security: disc !important;
        }
    </style>
</head>

<body>
<form id="login" method="POST" autocomplete="off">
    <img id="pro" src="4.png" width="187px" style="alt=foto">
    <h1>Опрос</h1>

    <fieldset id="inputs">
        <input id="username" type="text" name="login" placeholder="логин" autocomplete="off" autofocus required>   
        <input id="password" type="password" name="password" autocomplete="new-password" placeholder="пароль" required>
    </fieldset>
    <fieldset id="actions">
        <input type="submit" id="submit" value="войти" name="submit">
        <img src="MASH_Security_logo2.svg" width="200px" style="float:left; margin:0 0 0 100px" alt="logo">
    </fieldset>
    <a href="" id="back">&#169; Шереметьево безопасность</a>
    <div id="errorLog" class="blink"><?= $hello ?></div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let err = document.getElementById("errorLog");
    function clearError() { err.innerHTML = ""; }
    if(err.innerHTML.trim() !== "") {
        setTimeout(clearError, 5000);
    }
});
</script>
</body>
</html>