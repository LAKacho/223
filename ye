<?php
// Очистка всех куки
foreach($_COOKIE as $key => $value) {
    setcookie($key, '', time() - 3600, '/');
}

require __DIR__ . '/config.php';

$error = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $tb = $_POST['tb'] ?? '';
    if ($tb === '') {
        $error = 'Введите табельный номер';
    } else {
        try {
            $pdoAuth = new PDO(
                'mysql:host=localhost;dbname=1test_system;charset=utf8mb4',
                'root', '',
                [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::ATTR_EMULATE_PREPARES => false,
                ]
            );
            $st = $pdoAuth->prepare("SELECT fio FROM list WHERE tb = ? LIMIT 1");
            $st->execute([$tb]);
            $row = $st->fetch();
            if ($row) {
                setcookie('employee_number', $tb, time() + 3600*24*30, '/');
                header("Location: opros.php");
                exit;
            } else {
                $error = 'Пользователь с таким табельным номером не найден';
            }
        } catch (Throwable $e) {
            $error = 'Ошибка подключения к базе данных';
        }
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Вход 360°</title>
    <link href="style_xtvs.css" rel="stylesheet">
    <style>
        textarea[name="password"] {
            resize: none;
            -webkit-text-security: disc !important;
        }
    </style>
</head>

<body>
<form id="login" method="POST" autocomplete="off"> 
    <img id="pro" src="4.png" width="187px" height="348px"  alt="foto">
    <h2>Тестирование</h2>
    <h2>360&deg;</h2>
    
    <fieldset id="inputs">
        <input id="username" type="text" name="tb" placeholder="Табельный номер" autocomplete="off" autofocus required>   
    </fieldset>
    <fieldset id="actions">
        <input type="submit" id="submit" value="войти" name="submit">
        <img src="MASH_Security_logo2.svg" width="200px" style="float:left; margin: 0px 0px 0px 100px" alt="logo">
    </fieldset>
    <a href="" id="back">&#169; Шереметьево безопасность</a>
    <div id="errorLog" class="blink"><?= htmlspecialchars($error, ENT_QUOTES) ?></div>
</form>

<script>
document.addEventListener("DOMContentLoaded", error);
function error() {
    let err = document.getElementById("errorLog");
    function a() {
        err.innerHTML = "";
    }
    if(err.innerHTML !== "") {
        setTimeout(a, 5000);
    }   
}
</script>
</body>
</html>